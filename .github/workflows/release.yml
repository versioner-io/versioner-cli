name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-and-release:
    name: Build and Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.VERSION }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Build binaries
        run: |
          VERSION=${{ steps.get_version.outputs.VERSION }}
          COMMIT=$(git rev-parse --short HEAD)
          BUILD_DATE=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          LDFLAGS="-X 'github.com/versioner-io/versioner-cli/internal/version.Version=${VERSION}' -X 'github.com/versioner-io/versioner-cli/internal/version.Commit=${COMMIT}' -X 'github.com/versioner-io/versioner-cli/internal/version.BuildDate=${BUILD_DATE}'"

          mkdir -p dist

          # Linux amd64
          GOOS=linux GOARCH=amd64 go build -ldflags="$LDFLAGS" -o dist/versioner-linux-amd64 ./cmd/versioner

          # Linux arm64
          GOOS=linux GOARCH=arm64 go build -ldflags="$LDFLAGS" -o dist/versioner-linux-arm64 ./cmd/versioner

          # macOS amd64 (Intel)
          GOOS=darwin GOARCH=amd64 go build -ldflags="$LDFLAGS" -o dist/versioner-darwin-amd64 ./cmd/versioner

          # macOS arm64 (Apple Silicon)
          GOOS=darwin GOARCH=arm64 go build -ldflags="$LDFLAGS" -o dist/versioner-darwin-arm64 ./cmd/versioner

          # Windows amd64
          GOOS=windows GOARCH=amd64 go build -ldflags="$LDFLAGS" -o dist/versioner-windows-amd64.exe ./cmd/versioner

      - name: Generate checksums
        run: |
          cd dist
          sha256sum * > checksums.txt
          cat checksums.txt

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') || startsWith(github.ref, 'refs/tags/v0.') }}
          generate_release_notes: true
          files: |
            dist/versioner-linux-amd64
            dist/versioner-linux-arm64
            dist/versioner-darwin-amd64
            dist/versioner-darwin-arm64
            dist/versioner-windows-amd64.exe
            dist/checksums.txt
          body: |
            ## Installation

            Download the appropriate binary for your platform from the assets below.

            ### Linux (amd64)
            ```bash
            curl -L https://github.com/versioner-io/versioner-cli/releases/download/${{ steps.get_version.outputs.VERSION }}/versioner-linux-amd64 -o versioner
            chmod +x versioner
            sudo mv versioner /usr/local/bin/
            ```

            ### macOS (Apple Silicon)
            ```bash
            curl -L https://github.com/versioner-io/versioner-cli/releases/download/${{ steps.get_version.outputs.VERSION }}/versioner-darwin-arm64 -o versioner
            chmod +x versioner
            sudo mv versioner /usr/local/bin/
            ```

            ### macOS (Intel)
            ```bash
            curl -L https://github.com/versioner-io/versioner-cli/releases/download/${{ steps.get_version.outputs.VERSION }}/versioner-darwin-amd64 -o versioner
            chmod +x versioner
            sudo mv versioner /usr/local/bin/
            ```

            ### Verify Installation
            ```bash
            versioner version
            ```

            ## Quick Start

            1. Get your API key from [app.versioner.io](https://app.versioner.io)
            2. Set environment variable: `export VERSIONER_API_KEY=your-key`
            3. Track a build: `versioner track build --product=my-app --version=1.0.0 --status=completed`

            ## Documentation

            - [README](https://github.com/versioner-io/versioner-cli#readme)
            - [API Reference](https://api.versioner.io/docs)
            - [Web Dashboard](https://app.versioner.io)

            ## Verify Checksums

            Download `checksums.txt` and verify your binary:
            ```bash
            sha256sum -c checksums.txt --ignore-missing
            ```

      - name: Publish Release
        run: |
          gh release edit ${{ steps.get_version.outputs.VERSION }} --draft=false
        env:
          GH_TOKEN: ${{ github.token }}

  track-build:
    name: Track Build in Versioner
    runs-on: ubuntu-latest
    needs: build-and-release
    if: success()
    steps:
      - name: Track build success
        uses: versioner-io/versioner-github-action@main
        with:
          api_key: ${{ secrets.VERSIONER_API_KEY }}
          product_name: versioner-cli
          version: ${{ needs.build-and-release.outputs.version }}
          event_type: build
          status: success
          metadata: |
            {
              "release_url": "https://github.com/versioner-io/versioner-cli/releases/tag/${{ needs.build-and-release.outputs.version }}",
              "platforms": "linux-amd64,linux-arm64,darwin-amd64,darwin-arm64,windows-amd64"
            }

  track-build-failure:
    name: Track Build Failure in Versioner
    runs-on: ubuntu-latest
    needs: build-and-release
    if: failure()
    steps:
      - name: Track build failure
        uses: versioner-io/versioner-github-action@main
        with:
          api_key: ${{ secrets.VERSIONER_API_KEY }}
          product_name: versioner-cli
          version: ${{ github.ref_name }}
          event_type: build
          status: failed
